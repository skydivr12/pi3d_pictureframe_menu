#!/bin/bash

NOW=$(date +"%D_%T")
UPDAT_DIR=$HOME/.frame_updates
LOG1="$HOME/pic_frame/logs/download_log.txt"
LOG2="$HOME/pic_frame/logs/update_log.txt"
EMAILS=/usr/local/bin/get_images_from_emails.py
JUNK=$HOME/unknown_file_types
SOURCES=( "emails" "gdrive" )
TEMP_EMAILS=/attachments
TODAY=$(date +"%Y_%m_%d")

sort_pics() {
  if [ -f "$(find $DWNLD_DIR -type f)" ]; then
    sudo find $DWNLD_DIR -name "* *" -type f -exec rename 's/ /_/g' {} +
    for F in $(find $DWNLD_DIR -type f); do
      b=$(basename "$F")
      case $F in
        *.sh)
          sudo mv $F $UPDAT_DIR/ &&
          echo "At $NOW $F was put in $UPDAT_DIR/" >> $LOG2
          ;;
        *.[Tt][Ii][Ff][Ff] | *.[Dd][Nn][Gg] | *.[Pp][Nn][Gg] | *.[Jj][Pp][Gg] | *.[Jj][Pp][Ee][Gg] | *.[Hh][Ee][Ii][Ff] | *.[Hh][Ee][Ii][Cc])
          mogrify -auto-orient $F ;
          echo " Downloaded at $NOW   :  $b" >> $LOG1
          ;;
        *)
          if [ ! -d "$JUNK" ]; then mkdir -p $JUNK; fi
          sudo mv $F $JUNK &&
          echo "At $NOW $b was put in $JUNK/" >> $LOG1
          ;;
      esac
    done
  fi
}


ARR1=( "$(find ~/Pictures -type f -exec echo {} +)" )
for SRC_LOC in "${SOURCES[@]}"; do
  case $SRC_LOC in
    emails)
      #Assign temporary download directory to a variable.
      #Downloads pictures from gmail. Script creates temporary download folder if needed.
#      echo " About to download from email" && sleep 5
      sudo python3 $EMAILS
      DWNLD_DIR=$TEMP_EMAILS
#      echo " About to transfer downloaded pics to g drive" && sleep 5
      if [ -f "$(find $DWNLD_DIR -type f)" ]; then
        sudo rclone move -v $DWNLD_DIR/ drive:Pictures/emails/$TODAY/
      fi
      ;;
    gdrive)
      #Assign temporary download directory to a variable.
      DWNLD_DIR=$HOME/Pictures
      #If download directory doesnt exist, create it.
      if [ ! -d "$DWNLD_DIR" ]; then sudo mkdir -p $DWNLD_DIR; fi
      #Download pictures from google drive into a temporary download directory.
#      echo " About to download from google drive" && sleep 5
      sudo rclone sync -v drive:Pictures $DWNLD_DIR/
      ARR2=( "$(find $HOME/Pictures -type f -exec echo {} +)" )
      ARR3=( "$(echo ${ARR1[@]} ${ARR2[@]} | tr ' ' '\n' | sort | uniq -u | tr '\n' ' ')" )
#      echo " New pictures should be downloaded from google drive."
#      echo " Downloaded pictures include : ${ARR3[@]}"
#      echo " About to sort these pictures" && sleep 5

      sort_pics
      sudo rclone sync -v $DWNLD_DIR/ drive:Pictures
      ;;
  esac
done








